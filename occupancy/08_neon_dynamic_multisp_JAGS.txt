model {

# first, try automating the betas for each parameter.
# if that doesn't work, then write out each beta probability

# psi   - occupancy prob. varies across species and seasons
# phi   - survival prob. starts in season 2
# gamma - colonization prob. starts in season 2
# p     - detection prob. varies across species and seasons

# trap - i
# spec - j
# surv - k
# year - l

  # Priors
  
  psi_beta1 ~ dunif(0, 20)
  psi_beta2 ~ dunif(0, 20)
  p_beta1   ~ dunif(0, 20)
  p_beta2   ~ dunif(0, 20)
  phi_beta1 ~ dunif(0, 20)
  phi_beta2 ~ dunif(0, 20)
  gamma_beta1 ~ dunif(0, 20)
  gamma_beta2 ~ dunif(0, 20)

  #AIS where to define beta1/beta2? Outside for-loop OR inside year loop OR inside year and species loops? Do beta1/beta2 need to be specified for each parameter? For now, i've specified outside of loops and for each parameter, but this seems so clunky
  #AIS What if a psi value is less than the corresponding p value? Is that okay since this is just a rather uninformed prior?
  
  # Parameter values vary across species and year
  for (j in 1:nspec) {
    psi1[j] ~ dbeta(psi_beta1, psi_beta2) #AIS psi needs to be initialized for only the first year. This kicks off z in the state model, and the rest of psi is calculated from z. 
    for (l in 1:nyear) {
      p[j,l]    ~ dbeta(p_beta1, p_beta2)
      phi[j,l]  ~ dbeta(phi_beta1, phi_beta2)
      gamma[j,l]~ dbeta(gamma_beta1, gamma_beta2)
    }
  }
  
# trap - i
# spec - j
# surv - k
# year - l

  # State model
  # z dimensions: [ntrap, nspec, nyear]
  for (i in 1:ntrap) {
    for (j in 1:nspec) {
      z[i,j,1]  ~ dbern(psi1[j])
      for (l in 2:nyear) {
        muZ[i,j,l]  <- z[i,j,l-1]*phi[j,l-1] + 
                        (1 - z[i,j,l-1])*gamma[j,l-1]
        z[i,j,l]    ~ dbern(muZ[i,j,l]) 
      }
    }
  }

  # observation model
  for (i in 1:ntrap) {
    for (j in 1:nspec) {
      for (k in 1:nsurv) {
        for (l in 1:nyear) {
          muy[i,j,k,l]  ~ dbinom(z[i,j,l]*p[j,l], 1) #why dbinom(z*p) and not just z*p?
          y[i,j,k,l]    ~ dbern(muy[i,j,k,l])
          #AIS why compute muy then y and muz then z?
          #AIS detection prob does not vary across traps? I could make p vary across surveys in a season, right?
        }
      }
    }
  }
  
  # Derived parameters
  for (j in 1:nspec) {
    psi[j,1]  <- psi1[j]
    n.occ[j,1]  <- sum(z[1:ntrap,j,1])
    for (l in 2:nyear) {
      psi[j,l]        <- psi[j,l-1]*phi[j,l-1] + 
                          (1 - psi[j,l-1])*gamma[j,l-1] 
      n.occ[j,l]      <- sum(z[1:ntrap,j,l])
      growth[j,l]     <- psi[j,l]/psi[j,l-1]
      turnover[j,l-1] <- (1 - psi[j,l-1])*gamma[j,l-1]/psi[j,l] 
    }
  }
  
  
} #model

